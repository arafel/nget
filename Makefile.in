VERSION=0.15.1
CXXFLAGS=@CXXFLAGS@ -Wall @UUINC@ @DEFS@

CXX=@CXX@
LIBS=@LIBS@

srcdir=@srcdir@

prefix=@prefix@
exec_prefix=@exec_prefix@
bindir=@bindir@
mandir=@mandir@
install=@INSTALL@

all: .autostuff nget ngetlite

OBJS=nget.o prot_nntp.o sockstuff.o cache.o file.o termstuff.o misc.o strtoker.o strreps.o myregex.o datfile.o etree.o nrange.o log.o server.o @EXTRAOBJS@ @UULIB@
nget: $(OBJS) .depend 
	$(CXX) $(CXXFLAGS) $(LDFLAGS) $(OBJS) -o $@ $(LIBS)

LITEOBJS=lite.o litenntp.o log.o sockstuff.o strreps.o
ngetlite: $(LITEOBJS) .depend 
	$(CXX) $(CXXFLAGS) $(LDFLAGS) $(LITEOBJS) -o $@

@NOUU@@UULIB@:
@NOUU@	(cd @UUDIR@; ./configure)
@NOUU@	$(MAKE) -C @UUDIR@ libuu.a


nrangetest: nrangetest.o file.o sockstuff.o nrange.o log.o
	$(CXX) $(CXXFLAGS) $^ -o $@ $(LIBS)

filetest2: filetest2.o file.o sockstuff.o
	$(CXX) $(CXXFLAGS) $^ -o $@ $(LIBS)

filetest: filetest.o file.o sockstuff.o
	$(CXX) $(CXXFLAGS) $^ -o $@ $(LIBS)

dep depend .depend:
	$(CXX) $(CXXFLAGS) -MM *.cc > .depend

install_nget: nget
	$(install) -s -m 0755 nget $(bindir)
	$(install) -m 0644 nget.1 $(mandir)/man1

install_ngetlite: ngetlite
	$(install) -s -m 0755 ngetlite $(bindir)
	$(install) -m 0644 ngetlite.1 $(mandir)/man1

install: install_nget install_ngetlite

nget.txt ngetlite.txt: %.txt: %.1
	man -l $< | sed -e 's/.//g' > $@

win32dist: nget.txt ngetlite.txt
	-rm nget ngetlite
	$(MAKE) CXX="$(CXX) -static" nget ngetlite
	zip -j -9 ../nget-$(VERSION).win32.zip COPYING Changelog FAQ README.win32 nget.txt ngetlite.txt nget.exe ngetlite.exe /bin/cygwin1.dll


.autostuff: configure config.h.in config.h Makefile config.status

${srcdir}/configure: configure.in aclocal.m4
	cd ${srcdir} && autoconf

# autoheader might not change config.h.in, so touch a stamp file.
${srcdir}/config.h.in: stamp-h.in
${srcdir}/stamp-h.in: configure.in acconfig.h aclocal.m4
#config.h.top config.h.bot
	cd ${srcdir} && autoheader
	echo timestamp > ${srcdir}/stamp-h.in

${srcdir}/config.h: stamp-h
${srcdir}/stamp-h: config.h.in stamp-h.in config.status acconfig.h
	./config.status

Makefile: Makefile.in config.status
	./config.status

config.status: configure
	./config.status --recheck

#dist:
#	-make -C $(UUDIR) distclean
#	cd ..;tar -czhf nget/distro/nget-`egrep "nget v[0-9.]+ -" nget/nget.cc | sed "s/.*v\([0-9.]\+\).*/\1/"`-withuulib.tar.gz nget/README nget/Changelog nget/COPYING nget/*.cc nget/*.h nget/Makefile nget/nget.1 nget/uulib/
#	cd ..;tar -czhf nget/distro/nget-`egrep "nget v[0-9.]+ -" nget/nget.cc | sed "s/.*v\([0-9.]\+\).*/\1/"`.tar.gz nget/README nget/Changelog nget/COPYING nget/*.cc nget/*.h nget/Makefile nget/nget.1

clean:
	-rm nget ngetlite *.o nget.txt ngetlite.txt
	-$(MAKE) -C uulib clean

distclean: clean
	-rm config.status config.h config.cache config.log Makefile stamp-h .depend *~ .*~ *.rej tags .cvsignore .#*
	-rm -r CVS
	-$(MAKE) -C uulib distclean
#	-cp .depend.dist .depend

distclean-killuu: distclean
	-rm -r uulib
		 

#ifeq (.depend,$(wildcard .depend))
include .depend
#endif

.PHONY: all dep depend clean install dist distclean .autostuff
