VERSION=0.19.1
CXXFLAGS=@CXXFLAGS@ @DEFS@
CPPFLAGS=@UUINC@ @CPPFLAGS@
LDFLAGS=@LDFLAGS@

CXX=@CXX@
STRIP=@STRIP@
LIBS=@LIBS@
LITELIBS=@LITELIBS@

EXEEXT=@EXEEXT@
srcdir=@srcdir@

prefix=@prefix@
exec_prefix=@exec_prefix@
bindir=@bindir@
mandir=@mandir@
install=@INSTALL@
install_data=${install} -m 0644
install_bin=${install} -s -m 0755
install_dir=${install} -d

NGET=nget$(EXEEXT)
NGETLITE=ngetlite$(EXEEXT)

all: .autostuff $(NGET) $(NGETLITE)

INSTALLDIRS=$(bindir) $(mandir)/man1
W32DISTFILES=COPYING Changelog FAQ README.win32 nget.txt ngetlite.txt $(NGET) $(NGETLITE)

OBJS=nget.o prot_nntp.o sockpool.o sockstuff.o cache.o dupe_file.o file.o file_gz.o termstuff.o misc.o strtoker.o strreps.o myregex.o datfile.o argparser.o etree.o nrange.o log.o server.o @UULIB@
$(NGET): $(OBJS) .depend 
	$(CXX) $(CXXFLAGS) $(LDFLAGS) $(OBJS) -o $@ $(LIBS)

LITEOBJS=lite.o litenntp.o log.o sockstuff.o strreps.o file.o
$(NGETLITE): $(LITEOBJS) .depend 
	$(CXX) $(CXXFLAGS) $(LDFLAGS) $(LITEOBJS) -o $@ $(LITELIBS)

@NOUU@@UULIB@:
@NOUU@	(cd @UUDIR@ && ./configure)
@NOUU@	$(MAKE) -C @UUDIR@ libuu.a

test:
	$(MAKE) -C test test

filetest2: filetest2.o file.o sockstuff.o
	$(CXX) $(CXXFLAGS) $^ -o $@ $(LIBS)

filetest: filetest.o file.o sockstuff.o
	$(CXX) $(CXXFLAGS) $^ -o $@ $(LIBS)

dep depend .depend:
	$(CXX) $(CXXFLAGS) $(CPPFLAGS) -MM *.cc > .depend

$(INSTALLDIRS):
	$(install_dir) $@

install_nget: $(INSTALLDIRS) $(NGET)
	$(install_bin) $(NGET) $(bindir)
	$(install_data) nget.1 $(mandir)/man1

install_ngetlite: $(INSTALLDIRS) $(NGETLITE)
	$(install_bin) $(NGETLITE) $(bindir)
	$(install_data) ngetlite.1 $(mandir)/man1

install: install_nget install_ngetlite

nget.txt ngetlite.txt: %.txt: %.1
	man -l $< | sed -e 's/.//g' > $@

win32dist: $(W32DISTFILES)
	$(STRIP) $(NGET) $(NGETLITE)
	zip -j -9 ../nget-$(VERSION).win32.zip $(W32DISTFILES)
win32dist-static: $(W32DISTFILES)
	-rm $(NGET) $(NGETLITE)
	$(MAKE) CXX="$(CXX) -static" $(NGET) $(NGETLITE)
	$(STRIP) $(NGET) $(NGETLITE)
	zip -j -9 ../nget-$(VERSION).win32.zip $(W32DISTFILES)
cygwin32dist: $(W32DISTFILES)
	$(STRIP) $(NGET) $(NGETLITE)
	zip -j -9 ../nget-$(VERSION).cygwin32.zip $(W32DISTFILES)
cygwin32dist-static: $(W32DISTFILES)
	-rm $(NGET) $(NGETLITE)
	$(MAKE) CXX="$(CXX) -static" $(NGET) $(NGETLITE)
	$(STRIP) $(NGET) $(NGETLITE)
	zip -j -9 ../nget-$(VERSION).cygwin32.zip $(W32DISTFILES) /bin/cygwin1.dll


.autostuff: configure config.h.in config.h Makefile config.status

${srcdir}/configure: configure.in aclocal.m4
	cd ${srcdir} && autoconf

# autoheader might not change config.h.in, so touch a stamp file.
${srcdir}/config.h.in: stamp-h.in
${srcdir}/stamp-h.in: configure.in aclocal.m4
#config.h.top config.h.bot
	cd ${srcdir} && autoheader
	echo timestamp > ${srcdir}/stamp-h.in

${srcdir}/config.h: stamp-h
${srcdir}/stamp-h: config.h.in stamp-h.in config.status
	./config.status

Makefile: Makefile.in config.status
	./config.status

config.status: configure
	./config.status --recheck

#dist:
#	-make -C $(UUDIR) distclean
#	cd ..;tar -czhf nget/distro/nget-`egrep "nget v[0-9.]+ -" nget/nget.cc | sed "s/.*v\([0-9.]\+\).*/\1/"`-withuulib.tar.gz nget/README nget/Changelog nget/COPYING nget/*.cc nget/*.h nget/Makefile nget/nget.1 nget/uulib/
#	cd ..;tar -czhf nget/distro/nget-`egrep "nget v[0-9.]+ -" nget/nget.cc | sed "s/.*v\([0-9.]\+\).*/\1/"`.tar.gz nget/README nget/Changelog nget/COPYING nget/*.cc nget/*.h nget/Makefile nget/nget.1

clean:
	-rm $(NGET) $(NGETLITE) *.o nget.txt ngetlite.txt
	-$(MAKE) -C uulib clean
	-$(MAKE) -C test clean

distclean: clean
	-rm config.status config.h config.cache config.log Makefile stamp-h .depend *.rej .cvsignore tags
	-rm -r autom4te.cache `find . -regex '.*~\|.*/\.#.*' -o -name CVS`
	-$(MAKE) -C uulib distclean
#	-cp .depend.dist .depend
	-$(MAKE) -C test distclean

distclean-killuu: distclean
	-rm -r uulib
		 

#ifeq (.depend,$(wildcard .depend))
include .depend
#endif

.PHONY: all dep depend clean install dist distclean .autostuff test
